<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>ì¤€í˜¸ì˜ ë§ˆë²• IDE</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-title" content="ì¤€í˜¸ì˜ ë§ˆë²• IDE" /> 
<style>
  /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
  body, html {
    margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e1e; color: #ddd;
  }
  header {
    height: 40px; background: #007acc; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; color: white;
    user-select: none;
  }
  #container {
    flex: 1; display: flex; overflow: hidden;
  }
  #sidebar {
    width: 240px; background: #252526; color: #bbb; overflow-y: auto; border-right: 1px solid #333;
  }
  #sidebar h2 {
    margin: 8px 12px;
    font-weight: 600;
    font-size: 1.1em;
    border-bottom: 1px solid #444;
    padding-bottom: 4px;
  }
  #fileList {
    list-style: none; padding: 0; margin: 0;
  }
  #fileList li {
    padding: 6px 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  #fileList li:hover, #fileList li.active {
    background: #0e639c;
    color: white;
  }
  #fileList li .icon {
    font-size: 1.2em;
    width: 20px; text-align: center;
  }
  #editor {
    flex: 1;
    background: #1e1e1e;
  }
  #keyboard {
    height: 50px;
    background: #333;
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    overflow-x: auto;
    padding: 0 8px;
    user-select: none;
  }
  #keyboard .key {
    background: #555;
    color: white;
    margin: 0 4px;
    padding: 8px 12px;
    border-radius: 4px;
    font-weight: 700;
    cursor: pointer;
    flex-shrink: 0;
    user-select: none;
    transition: background 0.15s ease;
    font-family: monospace;
  }
  #keyboard .key:hover {
    background: #0e639c;
  }
  #footer {
    height: 100px;
    background: #1e1e1e;
    color: #bbb;
    font-family: monospace;
    font-size: 14px;
    overflow-y: auto;
    border-top: 1px solid #333;
    padding: 8px;
  }
  button {
    background: #0e639c;
    border: none;
    padding: 6px 12px;
    color: white;
    font-weight: 600;
    border-radius: 3px;
    cursor: pointer;
    user-select: none;
  }
  button:hover {
    background: #1177d3;
  }
  /* ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ ëŒ€ì‘ */
  @media (orientation: portrait) {
    #container {
      flex-direction: column;
    }
    #sidebar {
      width: 100%;
      height: 140px;
      border-right: none;
      border-bottom: 1px solid #333;
      overflow-x: auto;
      overflow-y: hidden;
      display: flex;
      flex-wrap: nowrap;
    }
    #fileList {
      display: flex;
      flex-wrap: nowrap;
    }
    #fileList li {
      flex: 0 0 auto;
      padding: 6px 16px;
      white-space: nowrap;
      border-right: 1px solid #444;
    }
    #editor {
      flex: 1;
      height: 50vh;
    }
    #footer {
      height: 80px;
      font-size: 12px;
    }
  }
</style>

<!-- Monaco ì—ë””í„° ë¡œë”© -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
</head>
<body>

<header>
  <div>ì¤€í˜¸ì˜ ë§ˆë²• IDE</div>
  <div>
    <button id="openFolderBtn">í´ë”/íŒŒì¼ ì—´ê¸°</button>
    <button id="saveBtn">ì €ì¥ ğŸ’¾</button>
    <button id="runBtn">ì‹¤í–‰ â–¶</button>
  </div>
</header>

<div id="container">
  <nav id="sidebar">
    <h2>íŒŒì¼ ëª©ë¡</h2>
    <ul id="fileList"></ul>
  </nav>
  <main id="editor"></main>
</div>

<div id="keyboard">
  <div class="key" data-key="âŒ˜">âŒ˜</div>
  <div class="key" data-key="âŒ¥">âŒ¥</div>
  <div class="key" data-key="âŒƒ">âŒƒ</div>
  <div class="key" data-key="â‡§">â‡§</div>
  <div class="key" data-key="â‹">â‹</div>
  <div class="key" data-key="âŒ«">âŒ«</div>
  <div class="key" data-key="â‡¥">â‡¥</div>
  <div class="key" data-key="{}">{}</div>
  <div class="key" data-key="()">( )</div>
  <div class="key" data-key="[]">[ ]</div>
  <div class="key" data-key="<>">&lt;&gt;</div>
  <div class="key" data-key=";">;</div>
</div>

<div id="footer" contenteditable="false" spellcheck="false"></div>

<script>
  // í™•ì¥ìë³„ ì•„ì´ì½˜ ë§¤í•‘
  const iconMap = {
    js: 'ğŸ“„',
    ts: 'ğŸ§ ',
    html: 'ğŸŒ',
    css: 'ğŸ¨',
    json: 'ğŸ—‚ï¸'
  };

  // ì§€ì›í•˜ëŠ” í™•ì¥ì ëª©ë¡
  const supportedExts = Object.keys(iconMap);

  // ì—´ë¦° íŒŒì¼ í•¸ë“¤ ì €ì¥
  let currentFileHandle = null;

  // ì—¬ëŸ¬ íŒŒì¼ ì •ë³´ ì €ì¥ {name, handle, content}
  let files = [];

  // Monaco ì—ë””í„° ì¸ìŠ¤í„´ìŠ¤
  let editor = null;

  // í‚¤ë³´ë“œ ìƒíƒœ í”Œë˜ê·¸
  let keyboardState = { cmd: false, alt: false, ctrl: false, shift: false };

  require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(document.getElementById('editor'), {
      value: '',
      language: 'javascript',
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 14,
      minimap: { enabled: false }
    });
  });

  // ì‚¬ì´ë“œë°” íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  function renderFileList() {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    files.forEach((f, i) => {
      const ext = f.name.split('.').pop().toLowerCase();
      const icon = iconMap[ext] || 'ğŸ“';
      const li = document.createElement('li');
      li.className = (currentFileHandle === f.handle) ? 'active' : '';
      li.innerHTML = `<span class="icon">${icon}</span> ${f.name}`;
      li.onclick = () => openFileInEditor(i);
      fileList.appendChild(li);
    });
  }

  // íŒŒì¼ ë‚´ìš©ì„ ì—ë””í„°ì— ë¡œë“œ
  function openFileInEditor(index) {
    const file = files[index];
    editor.setValue(file.content);
    currentFileHandle = file.handle;
    renderFileList();
  }

  // ë¡œì»¬ í´ë” ë˜ëŠ” íŒŒì¼ ì—´ê¸° (Safari ëŒ€ì‘ í¬í•¨)
  async function openFolderOrFiles() {
    files = [];
    currentFileHandle = null;

    if ('showDirectoryPicker' in window) {
      // í¬ë¡¬ ë“± í´ë” ì—´ê¸° ì§€ì› ë¸Œë¼ìš°ì €
      try {
        const dirHandle = await window.showDirectoryPicker();
        await traverseDir(dirHandle);
        if(files.length) {
          openFileInEditor(0);
        }
        renderFileList();
      } catch (e) {
        alert('í´ë” ì—´ê¸° ì·¨ì†Œ ë˜ëŠ” ì˜¤ë¥˜: ' + e.message);
      }
    } else if ('showOpenFilePicker' in window) {
      // ì‚¬íŒŒë¦¬ ë“± í´ë” ì—´ê¸° ë¯¸ì§€ì› ë¸Œë¼ìš°ì € â†’ ë‹¨ì¼ íŒŒì¼ ì„ íƒë§Œ
      try {
        const fileHandles = await window.showOpenFilePicker({
          multiple: true,
          types: [{
            description: 'Supported files',
            accept: {
              'text/javascript': ['.js'],
              'text/html': ['.html'],
              'text/css': ['.css'],
              'application/json': ['.json']
            }
          }]
        });
        for (const handle of fileHandles) {
          const file = await handle.getFile();
          const ext = file.name.split('.').pop().toLowerCase();
          if (!supportedExts.includes(ext)) continue;
          const content = await file.text();
          files.push({name: file.name, content, handle});
        }
        if(files.length) {
          openFileInEditor(0);
        }
        renderFileList();
      } catch(e) {
        alert('íŒŒì¼ ì—´ê¸° ì·¨ì†Œ ë˜ëŠ” ì˜¤ë¥˜: ' + e.message);
      }
    } else {
      alert('ì´ ë¸Œë¼ìš°ì €ëŠ” íŒŒì¼/í´ë” ì—´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
  }

  // í´ë” ì¬ê·€ íƒìƒ‰ (íŒŒì¼ë§Œ ìˆ˜ì§‘, í™•ì¥ì í•„í„°ë§)
  async function traverseDir(dirHandle) {
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'file') {
        const ext = entry.name.split('.').pop().toLowerCase();
        if (!supportedExts.includes(ext)) continue;
        const file = await entry.getFile();
        const content = await file.text();
        files.push({ name: entry.name, content, handle: entry });
      } else if (entry.kind === 'directory') {
        await traverseDir(entry);
      }
    }
  }

  // ì €ì¥ (í˜„ì¬ ì—´ë ¤ìˆëŠ” íŒŒì¼ì— ì €ì¥)
  async function saveFile() {
    if (!currentFileHandle) {
      alert('ì €ì¥í•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }
    try {
      const writable = await currentFileHandle.createWritable();
      await writable.write(editor.getValue());
      await writable.close();
      logToConsole(`âœ… ${getFileName(currentFileHandle)} ì €ì¥ ì™„ë£Œ`);
    } catch (e) {
      alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
  }

  // ì½˜ì†” ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
  function logToConsole(msg) {
    const footer = document.getElementById('footer');
    footer.textContent += msg + '\n';
    footer.scrollTop = footer.scrollHeight;
  }

  // ì‹¤í–‰ ë²„íŠ¼ ëˆ„ë¥´ë©´ JS ì½”ë“œ ì‹¤í–‰ (eval ì‚¬ìš©)
  function runCode() {
    const code = editor.getValue();
    logToConsole('â–¶ ì‹¤í–‰ ì¤‘...');
    try {
      // eslint-disable-next-line no-eval
      const result = eval(code);
      logToConsole('ğŸ’¡ ê²°ê³¼: ' + result);
    } catch (e) {
      logToConsole('âŒ ì˜¤ë¥˜: ' + e.message);
    }
  }

  // í˜„ì¬ íŒŒì¼ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  function getFileName(handle) {
    if (handle.name) return handle.name;
    if (handle.getFile) return handle.getFile().then(f => f.name);
    return 'ì•Œìˆ˜ì—†ëŠ”íŒŒì¼';
  }

  // ê°€ìƒ í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬
  function insertSnippet(snippet) {
    const pos = editor.getPosition();
    editor.executeEdits('', [{
      range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column),
      text: snippet,
      forceMoveMarkers: true
    }]);
    editor.focus();
  }

  // í‚¤ë³´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('keyboard').addEventListener('click', e => {
    if (e.target.classList.contains('key')) {
      const key = e.target.dataset.key;
      if(key === 'âŒ«') {
        editor.trigger('keyboard', 'deleteLeft', {});
      } else if (key === 'â‡¥') {
        editor.trigger('keyboard', 'tab', {});
      } else {
        insertSnippet(key);
      }
    }
  });

  // ë‹¨ì¶•í‚¤ ì²˜ë¦¬ (ì˜ˆ: âŒ˜+S ì €ì¥)
  window.addEventListener('keydown', e => {
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      saveFile();
    }
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'r') {
      e.preventDefault();
      runCode();
    }
  });

  // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById('openFolderBtn').onclick = openFolderOrFiles;
  document.getElementById('saveBtn').onclick = saveFile;
  document.getElementById('runBtn').onclick = runCode;

</script>

</body>
</html>
